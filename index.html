<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>Dynamically Sassy</title>

    <meta name="description" content="Dynamically Sassy - Generating dynamic Sass and CSS.">
    <meta name="author" content="Jeremy Fairbank">

    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/night-revised.css" id="theme">
    <link rel="stylesheet" href="css/custom.css">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/solarized_dark.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">

      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section>
          <h2>Dynamically Sassy</h2>
          <h3>Generating Dynamic CSS in Rails</h3>
          <h4>
            <a href="http://blog.jeremyfairbank.com">Jeremy Fairbank</a>
          </h4>
          
          <small>
            <a href="https://twitter.com/elpapapollo">@elpapapollo</a> /
            <a href="https://github.com/jfairbank">github.com/jfairbank</a>
          </small>
        </section>

        <section>
          <h2>Hi, I'm Jeremy</h2>
          <img width="300" src="/img/bio-photo-circle-512x512.png">
          <!--<img style="float: left;" width="300" src="/img/bio-photo-1-500x500.jpg">-->

            <p>
              Web Developer @ <a href="https://www.pushagency.io">Push Agency</a>
            </p>

            <p>
              Rails, Node, Angular, Backbone, and Marionette
            </p>
        </section>

        <section data-background="#27252A">
          <img src="/img/simplybuilt.png" width="400">
          <br>
          <img src="/img/simplybuilt-editor-2.jpg" height="400">
          <br>
          <strong>
            <a href="https://www.simplybuilt.com">simplybuilt.com</a>
          </strong>
        </section>

        <section data-background="#fafafa">
          <h2 style="color: #555;">Our Problem</h2>
          <img src="/img/color-palettes.jpg">
        </section>

        <section>
          <h1>Issues</h1>
          <ol>
            <li>Same Sass style sheet to render default and custom colors</li>
            <li>Rendering custom color style sheets from a controller</li>
            <li>Slow HTTP requests</li>
            <li>Caching custom style sheets</li>
            <li>Background processing</li>
          </ol>
        </section>

        <section>
          <img width="300" src="/img/sass.png">
          <h4>Syntactically Awesome Style Sheets</h4>
        </section>

        <section>
          <h2>
            <img height="100" src="/img/sass.png" style="vertical-align: middle;">
            <span style="vertical-align: middle;">in Action</span>
          </h2>
          <pre><code class="scss">
    // Variables
    $font-size: 12px;

    // Nested rules
    #foo {
      .bar {
        font-size: $font-size;
      }
    }
          </code></pre>

          <pre><code class="scss">
    // Mixins
    @mixin has-cats {
      &::before {
        content: 'meow';
        display: block;
      }
    }

    #internet {
      @include has-cats;
    }
          </code></pre>
        </section>

        <section>
          <h1>So What?</h1>
          <img width="200" src="/img/sass.png" style="margin-right: 30px; vertical-align: middle;">
          <ul style="vertical-align: middle;">
            <li>Modularity</li>
            <li>DRY</li>
            <li>Data Structures</li>
            <li>Color Logic</li>
          </ul>
        </section>

        <section>
          <h2>Reusing style sheets</h2>
          <h4>It's all in the variables</h4>
          <pre><code class="scss">
    // palette1.scss
    $palette: (red green);
    @import 'my-ui';
          </code></pre>

          <pre><code class="scss">
    // palette2.scss
    $palette: (blue yellow);
    @import 'my-ui';
          </code></pre>

          <pre><code class="scss">
    // _my-ui.scss
    #foo {
      background: nth($palette, 1);
      color: nth($palette, 2);
    }
          </code></pre>
        </section>

        <section>
          <h2>Making it Dynamic</h2>

          <pre><code class="scss">
    // dynamic-palette.scss
    $palette: get-dynamic-palette();
    @import 'my-ui';
          </code></pre>

          <pre><code class="ruby">
    # config/initializers/sass.rb
    module Sass::Script::Functions
      def get_dynamic_palette
        palette = 2.times.map do
          color = '#%06x' % (rand * 0xffffff)
          Sass::Script::Value::Color.from_hex(color)
        end

        Sass::Script::Value::List.new(palette, :space)
      end
    end
          </code></pre>
        </section>

        <section>
          <h2>Injecting data from the user</h2>

          <pre><code class="scss">
    // app/assets/stylesheets/dynamic-palette-rails.css.scss
    $palette: get-dynamic-palette-from-user-somehow-magically();
    @import 'my-ui';
          </code></pre>
        </section>

        <section>
          <h2>Use the asset pipeline?</h2>
        </section>

        <section>
          <h3>Static context in the asset pipeline</h3>
          <pre><code class="ruby">
  # sass-rails/lib/sass/rails/template.rb
  module Sass
    module Rails
      class SassTemplate < Tilt::Template
        # ...
        def evaluate(context, locals, &block)
          cache_store = CacheStore.new(context.environment)

          options = {
            :filename => eval_file,
            :line => line,
            :syntax => syntax,
            :cache_store => cache_store,
            :importer => importer_class.new(context.pathname.to_s),
            :load_paths => context.environment.paths.map { |path| importer_class.new(path.to_s) },
            :sprockets => {
              :context => context,
              :environment => context.environment
            }
          }

          sass_config = context.sass_config.merge(options)

          engine = ::Sass::Engine.new(data, sass_config)
          css = engine.render

          engine.dependencies.map do |dependency|
            context.depend_on(dependency.options[:filename])
          end

          css
        rescue ::Sass::SyntaxError => e
          context.__LINE__ = e.sass_backtrace.first[:line]
          raise e
        end
        # ...
      end
    end
  end
          </code></pre>
        </section>

        <section>
          <h2>Oh, and assets are precompiled for production</h2>
        </section>

        <section>
          <h2>We need our own render class for dynamic content</h2>
        </section>

        <!--<section>-->
          <!--<h2><code>Sass::Engine</code> to the rescue</h2>-->
          <!--<pre><code class="ruby">-->
    <!--TEMPLATE = <<-EOS-->
      <!--$color: red;-->
      <!--.foo { color: $color; }-->
    <!--EOS-->

    <!--css = Sass::Engine.new(TEMPLATE, {-->
      <!--syntax: :scss,-->
      <!--style: :expanded-->
    <!--})-->

    <!--puts css-->
          <!--</code></pre>-->
          <!--<pre><code class="css">-->
    <!--.foo {-->
      <!--color: red;-->
    <!--}-->
          <!--</code></pre>-->
        <!--</section>-->

        <!--<section data-background="#0597FE">-->
          <!--<h2>Global State</h2>-->
          <!--<img src="/img/network-cables.jpg" height="400">-->
        <!--</section>-->

        <section>
          <h2><code>Sass::Engine</code> to the rescue</h2>
          <pre><code class="ruby" style="max-height: none;">
    # lib/sass_custom_palette.rb
    class SassCustomPalette
      TEMPLATE = <<-EOS.freeze
        $palette: get-custom-palette();
        @import 'my-ui';
      EOS

      def initialize(color)
        @color = color
      end

      def render
        Sass::Engine.new(TEMPLATE, sass_custom_options).render
      end

      private

      def sass_custom_options
        { syntax: :scss,
          style: :expanded,
          custom: { color: @color } }
      end
    end
          </code></pre>
        </section>

        <section>
          <pre><code class="ruby">
    # app/controllers/palettes_controller.rb
    class PalettesController < ApplicationController
      def custom_palette
        custom_renderer = SassCustomPalette.new(params[:custom_color])
        @css = custom_renderer.render
      end
    end
          </code></pre>

          <pre><code class="haml">
    -# app/views/palettes/custom_palette.css.haml
    = @css.html_safe
          </code></pre>

          <pre><code class="ruby">
    # config/initializers/sass.rb
    module Sass::Script::Functions
      def get_custom_palette
        color = Sass::Script::Value::Color.from_hex(options[:custom][:color])

        factor = Sass::Script::Value::Number.new(20, '%')

        palette = [lighten(color, factor), darken(color, factor)]

        Sass::Script::Value::List.new(palette, :space)
      end
    end
          </code></pre>
        </section>

        <section>
          <h1><code>-__-</code></h1>
          <pre><code class="markdown">
    Sass::SyntaxError - File to import not found or unreadable: my-ui.
          </code></pre>
        </section>

        <section>
          <h2>All about the <code>load_paths</code></h2>
          <pre><code class="scss">
    // app/assets/stylesheets/includes/_my-ui.scss
    #foo {
      background: nth($palette, 1);
      color: nth($palette, 2);
    }
          </code></pre>
          <pre><code class="ruby">
    class SassCustomPalette
      private

      def load_paths
        root = Rails.root.join('app', 'assets', 'stylesheets')
        Dir[root.join('includes')]
      end
      
      def sass_custom_options
        { syntax: :scss,
          style: :expanded,
          load_paths: load_paths,
          custom: { color: @color } }
      end
    end
          </code></pre>
        </section>

        <section>
          <h2>
            <a href="http://localhost:3000/palettes" target="_blank">Dynamic Sass Demo</a>
          </h2>
        </section>

        <!--<section>-->
          <!--<h4 class="fragment" style="color: #f00;"><code>#ff0000</code></h4>-->
          <!--<div class="fragment" style="background: #f66; color: #900; float: left; margin-left: 100px; padding: 10px;">-->
            <!--Hello World-->
          <!--</div>-->
          <!--<pre class="fragment" style="float: left; margin: 0 0 0 20px; width: 400px;"><code class="css">-->
    <!--#foo {-->
      <!--background: #ff6666;-->
      <!--color: #990000;-->
    <!--}-->
          <!--</code></pre>-->
          <!--<div style="clear: both; margin-bottom: 20px;"></div>-->

          <!--<h4 class="fragment" style="color: #0f0;"><code>#00ff00</code></h4>-->
          <!--<div class="fragment" style="background: #6f6; color: #090; float: left; margin-left: 100px; padding: 10px;">-->
            <!--Hello World-->
          <!--</div>-->
          <!--<pre class="fragment" style="float: left; margin: 0 0 0 20px; width: 400px;"><code class="css">-->
    <!--#foo {-->
      <!--background: #66ff66;-->
      <!--color: #009900;-->
    <!--}-->
          <!--</code></pre>-->
          <!--<div style="clear: both; margin-bottom: 20px;"></div>-->

          <!--<h4 class="fragment" style="color: #00f;"><code>#0000ff</code></h4>-->
          <!--<div class="fragment" style="background: #66f; color: #009; float: left; margin-left: 100px; padding: 10px;">-->
            <!--Hello World-->
          <!--</div>-->
          <!--<pre class="fragment" style="float: left; margin: 0 0 0 20px; width: 400px;"><code class="css">-->
    <!--#foo {-->
      <!--background: #6666ff;-->
      <!--color: #000099;-->
    <!--}-->
          <!--</code></pre>-->
        <!--</section>-->

        <section>
          <h3>Implementing in SimplyBuilt</h3>
          <p class="fragment">Try out an HTTP request...</p>
          <span class="fragment">...waiting</span>
          <span class="fragment">...waiting</span>
          <span class="fragment">...waiting</span>
          <p class="fragment">...done!</p>

          <div class="fragment">
            <h3>Uh Oh</h3>
            <img width="700" src="/img/high-request.png">
          </div>
        </section>

        <section data-center="false">
          <div class="worker worker1"></div>
          <div class="worker worker2"></div>
          <div class="worker worker3"></div>
          <div class="worker worker4"></div>
        </section>

        <section>
          <h2>Yup, we need caching</h2>

          <p data-markdown>
            [memcached.org](http://memcached.org) /
            [github.com/mperham/dalli](https://github.com/mperham/dalli)
          </p>

          <pre><code class="ruby">
    # config/environments/production.rb
    config.cache_store = :mem_cache_store, MEM_CACHE_SERVER, MEM_CACHE_OPTIONS
          </code></pre>

          <pre><code class="ruby">
    Rails.cache.write('foo', 'bar')

    Rails.cache.fetch('foo') #=> 'bar'
          </code></pre>
        </section>

        <section>
          <h2>Introduce caching into our Sass rendering</h2>
        </section>

        <section>
          <h4>Custom class for rendering and caching</h4>

          <pre><code class="ruby" style="max-height: none;">
    class SassRenderer
      def initialize(template, cache_key, options)
        @cache_key = cache_key
        @engine = Sass::Engine.new(template, options)
      end

      def render
        from_cache do
          @engine.render
        end
      end

      def cached?
        Rails.cache.exist?(@cache_key)
      end

      def get_cached_css
        Rails.cache.fetch(@cache_key)
      end

      private

      def set_cached_css(css)
        Rails.cache.write(@cache_key, css)
      end

      def from_cache(&write_block)
        get_cached_css || write_block.call.tap { |css| set_cached_css(css) }
      end
    end
          </code></pre>
        </section>

        <section>
          <h3>Incorporate into <code>SassCustomPalette</code></h3>

          <pre><code class="ruby">
    class SassCustomPalette
      def initialize(color)
        @color = color
        @cache_key = "custom_palette/#{@color}"
        @engine = SassRenderer.new(TEMPLATE, @cache_key, sass_custom_options)
      end

      def render
        @engine.render
      end
    end
          </code></pre>

          <h2 class="fragment">And?</h2>
          <img class="fragment" width="800" src="/img/quick-request.png">
        </section>

        <section>
          <h2>Process initial render<br>in the background</h2>
          <img width="250" src="/img/sidekiq.png">
          <p data-markdown>
            [sidekiq.org](http://sidekiq.org/)
          </p>
        </section>

        <section>
          <pre><code class="ruby">
    class SassCustomPaletteWorker
      include Sidekiq::Worker

      def perform(color)
        SassCustomPalette.new(color).render
      end
    end
          </code></pre>

          <pre><code class="ruby">
    class SassCustomPalette
      def render_async
        unless @engine.cached?
          SassCustomPaletteWorker.render_css(@color)
        end

        @cache_key
      end
    end
          </code></pre>
        </section>

        <section>
          <pre><code class="ruby">
    # app/controllers/palettes_controller.rb
    class PalettesController < ApplicationController
      def custom_palette
        @css = SassRenderer.get_by_key(params[:key])
      end

      def request_custom_palette
        custom_renderer = SassCustomPalette.new(params[:custom_color])
        @key = custom_renderer.render_async
      end
    end
          </code></pre>

          <pre><code class="ruby">
    class SassRenderer
      def self.get_by_key(key)
        Rails.cache.fetch(key)
      end

      private

      def get_cached_css
        self.class.get_by_key(@cache_key)
      end
    end
          </code></pre>
        </section>

      </div>

    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: true,
        progress: true,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom
        backgroundTransition: 'slide',

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, condition: function() { return !!document.querySelector( 'pre code' ); }, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
